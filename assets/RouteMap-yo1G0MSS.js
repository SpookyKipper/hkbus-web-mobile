import{r as k,a9 as w,a5 as E,j as l,J as R,a6 as I,aV as p,bc as J,aa as O,a$ as v}from"./index-DFZu2Cek.js";import{c as T,l as G,d as W,e as B,f as D,a as y,L as b,M as V,B as Z,b as H}from"./BaseTile-ChdxGG_O.js";import{S as P,C as q}from"./CompassControl-Cuo2ZIpa.js";import"./App-BeJzRQya.js";import"./index-n5_6LlAo.js";const z=T(function({data:n,...r},u){const a=new G.GeoJSON(n,r);return W(a,B(u,{overlayContainer:a}))},function(n,r,u){r.style!==u.style&&(r.style==null?n.resetStyle():n.setStyle(r.style))}),K=(t,n)=>{const[r,u]=k.useState(null),{db:{routeList:a}}=k.useContext(w),{gtfsId:h,bound:$,co:d,route:M,dest:j}=a[t];return k.useEffect(()=>{let S="";return h?S=`${h}-${$[d[0]]==="I"?"I":"O"}.json`:d.includes("mtr")?S=`${t.split("-")[0].toLowerCase()}.json`:M&&d.includes("lightRail")&&(S=`${M}${j.en.includes("Circular")?"":$[d[0]]==="I"?"_I":"_O"}.json`),fetch(`https://hkbus.github.io/route-waypoints/${S}`).then(s=>s.json()).then(s=>{u(s)}).catch(()=>{u({features:[{type:"Feature",geometry:{type:"LineString",coordinates:n.reduce((s,{location:{lat:x,lng:i}})=>(s.push([i,x]),s),[])}}],type:"FeatureCollection"})}),()=>{u(null)}},[t,h,$,d,n,j,M]),r},U=()=>{const[t,n]=k.useState(X),r=E(),u=D();return k.useEffect(()=>{fetch("https://data.hkbus.app/exits.mtr.json").then(a=>a.json()).then(a=>{n(h=>({...h,exits:a}))}),u.on("zoomend",function(){n(a=>({...a,icon:u.getZoom()>=17,label:u.getZoom()>=18}))})},[u]),l.jsx(l.Fragment,{children:t.exits.map(a=>l.jsxs(R.Fragment,{children:[t.icon&&l.jsx(y,{position:a,icon:b.divIcon({iconSize:[15,12],iconAnchor:[7.5,5],className:"mtr-exit"}),alt:a.name[r]}),t.label&&l.jsx(y,{position:a,icon:b.divIcon({html:a.exit,iconAnchor:[-9,7.5],className:"mtr-exit-label"})}),t.label&&a.barrierFree&&l.jsx(y,{position:a,icon:b.divIcon({iconSize:[12,11],iconAnchor:[-20,5],className:"mtr-exit-barrier-free"})})]},`${a.name.en}-${a.exit}`))})},X={exits:[],icon:!1,label:!1},oe=({routeId:t,stopIds:n,stopIdx:r,route:u,companies:a,onMarkerClick:h})=>{var N;const{geolocation:$,geoPermission:d,updateGeoPermission:M}=k.useContext(I),{db:{stopList:j}}=k.useContext(w),S=E(),[s,x]=k.useState(null),i=k.useMemo(()=>n.map(c=>j[c]),[j,n]),f=K(t,i),o=k.useRef({initialCenter:i[r]?i[r].location:p(),currentStopCenter:i[r]?i[r].location:p(),center:i[r]?i[r].location:p(),isFollow:!1,stops:i,stopIdx:r});k.useEffect(()=>{var L,F;let c,g;o.current.stops!==i||o.current.stopIdx!==r?c=!1:c=o.current.isFollow,o.current.stops===i&&o.current.stopIdx===r&&c?g=$.current:g=i[r]?i[r].location:p();const C=o.current.center;C!==g&&!J(g,C)&&(o.current.stops!==i?(L=o.current.map)==null||L.setView(g):(F=o.current.map)==null||F.flyTo(g)),o.current={...o.current,center:g,currentStopCenter:i[r]?i[r].location:p(),stops:i,stopIdx:r,isFollow:c}},[i,r,$]),k.useEffect(()=>{if(s){o.current={...o.current,map:s};const c=()=>{o.current={...o.current,center:o.current.currentStopCenter,isFollow:!1}};return s==null||s.on({dragend:c,dragstart:c}),s==null||s.setView(o.current.center),s==null||s.invalidateSize(),()=>{s.off({dragstart:c,dragend:c})}}},[s]);const _=k.useCallback(()=>{var c;d==="granted"?((c=o.current.map)==null||c.flyTo($.current),o.current={...o.current,center:$.current,isFollow:!0}):d!=="denied"&&(o.current={...o.current,isFollow:!0},M("opening"))},[$,d,M]);return l.jsx(O,{id:"route-map",sx:Y,children:l.jsxs(V,{center:o.current.initialCenter,zoom:16,scrollWheelZoom:!1,className:e.mapContainer,ref:x,children:[l.jsx(Z,{}),l.jsx(U,{}),i.map((c,g)=>l.jsx(y,{position:c.location,icon:Q({active:g===r,passed:g<r,companies:a}),alt:`${g}. ${c.name[S]}`,eventHandlers:{click:C=>{h(g,C)}}},`${c.location.lng}-${c.location.lat}-${g}`)),((N=f==null?void 0:f.features)==null?void 0:N.length)&&l.jsxs(l.Fragment,{children:[l.jsx(z,{data:f,style:A(a,u,!0)},f==null?void 0:f.timeStamp),l.jsx(z,{data:f,style:A(a,u,!1)},f==null?void 0:f.timeStamp)]}),l.jsx(P,{}),l.jsx(H,{onClick:_}),l.jsx(q,{})]})})},A=(t,n,r)=>function(){return{color:r?"#000000":v(t,n),weight:r?6:4,className:t.includes("ctb")&&t.includes("kmb")&&!r?e.jointlyLine:void 0}},Q=({active:t,passed:n,companies:r})=>r[0]==="mtr"?b.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r.includes("lightRail")?b.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r[0].startsWith("gmb")?b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.gmbMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r.includes("lrtfeeder")?b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.lrtfeederMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r.includes("nlb")?b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.nlbMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r.includes("ctb")&&r.includes("kmb")?b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.jointlyMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):r.includes("ctb")?b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.ctbMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}):b.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.kmbMarker} ${e.marker} ${t?e.active:""} ${n?e.passed:""}`}),m="map",e={mapContainerBox:`${m}-mapContainerBox`,mapContainer:`${m}-mapContainer`,centerControl:`${m}-centerControl`,marker:`${m}-marker`,mtrMarker:`${m}-mtrMarker`,gmbMarker:`${m}-gmbMarker`,ctbMarker:`${m}-ctbMarker`,jointlyMarker:`${m}-jointlyMarker`,lrtfeederMarker:`${m}-lrtfeederMarker`,nlbMarker:`${m}-nlbMarker`,kmbMarker:`${m}-kmbMarker`,jointlyLine:`${m}-jointlyLine`,active:`${m}-active`,passed:`${m}-passed`},Y={height:"35vh",filter:t=>t.palette.mode==="dark"?"brightness(0.8)":"none",[`& .${e.mapContainer}`]:{height:"35vh"},[`& .${e.mtrMarker}`]:{backgroundImage:"url(/img/mtr.svg)"},[`& .${e.gmbMarker}`]:{backgroundImage:"url(/img/minibus.svg)"},[`& .${e.ctbMarker}`]:{backgroundImage:"url(/img/bus_ctb.svg)"},[`& .${e.jointlyMarker}`]:{backgroundImage:"url(/img/bus_jointly.svg)"},[`& .${e.lrtfeederMarker}`]:{backgroundImage:"url(/img/bus_lrtfeeder.svg)"},[`& .${e.nlbMarker}`]:{backgroundImage:"url(/img/bus_nlb.svg)"},[`& .${e.kmbMarker}`]:{backgroundImage:"url(/img/bus_kmb.svg)"},[`& .${e.jointlyLine}`]:{stroke:v(["kmb"],""),animation:`${e.jointlyLine}-color 10s infinite linear 1.5s`},[`@keyframes ${e.jointlyLine}-color`]:{"50%":{stroke:v(["ctb"],"")},"100%":{stroke:v(["kmb"],"")}},[`& .${e.active}`]:{animation:"blinker 1.5s infinite"},[`& .${e.passed}`]:{filter:"grayscale(100%)"},"& .self-center":{backgroundImage:"url(/img/self.svg)",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",transition:"transform 0.1s ease-out",transformOrigin:"center"},"& .mtr-exit":{backgroundImage:"url(/img/HK_MTR_logo.svg)"},"& .mtr-exit-label":{background:"transparent",color:"#AC2E44",fontWeight:600},"& .mtr-exit-barrier-free":{backgroundImage:"url(/img/Wheelchair_symbol.svg)",backgroundSize:"12px 11px"}};export{oe as default};
